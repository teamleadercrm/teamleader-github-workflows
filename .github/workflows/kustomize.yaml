name: "Kustomize"
on:
  workflow_call:
    inputs:
      kustomize:
        description: "Kustomize tag to image"
        required: true
        type: string
      env:
        description: "Environment to update"
        required: true
        type: string

jobs:
  kustomize:
    runs-on: self-hosted
    steps:
    - name: Check out code
      uses: actions/checkout@v3
    - name: Setup Kustomize
      uses: imranismail/setup-kustomize@v1
      with:
        kustomize-version: "4.5.x"
    - name: Update Kubernetes resources
      run: |
        cd kustomize/env/${{ inputs.env }}
        kustomize edit set image ${{ inputs.kustomize }}:${{ github.sha }}
        cat kustomization.yaml
    - name: Push changes
      uses: stefanzweifel/git-auto-commit-action@v4
      with:
        commit_message: "Bump ${{ inputs.kustomize }} - ${{ inputs.env }} Kustomize image"
        push_options: --force
